# 数学公式渲染问题修复计划

## 问题分析
经过检查，发现数学公式无法渲染的主要原因有：

1. **CSS选择器错误**：CSS中使用`arithmatex`标签选择器，但pymdownx.arithmatex生成的是`<span class="arithmatex">`元素
2. **JavaScript选择器错误**：JavaScript中`querySelectorAll('arithmatex')`查找标签而非类
3. **内容检测逻辑缺陷**：`hasMathContent()`函数只检测原始LaTeX模式，不检测已生成的`.arithmatex`元素
4. **可能的配置冲突**：自定义renderActions可能干扰MathJax的自动处理

## 修复步骤

### 1. 修正CSS选择器
将`docs/stylesheets/mathjax.css`中所有`arithmatex`标签选择器改为`.arithmatex`类选择器：
- `arithmatex` → `.arithmatex`
- `arithmatex.MJXc-display` → `.arithmatex.MJXc-display`
- `arithmatex[display="true"]` → `.arithmatex[display="true"]`
- `[data-md-color-scheme="slate"] arithmatex` → `[data-md-color-scheme="slate"] .arithmatex`

### 2. 修正JavaScript选择器和逻辑
修改`docs/javascripts/mathjax-lazy.js`：

**A. 修正内容检测函数**：
- 在`hasMathContent()`中添加DOM查询：`contentArea.querySelector('.arithmatex')`
- 保留原有正则表达式检测作为后备

**B. 修正自定义renderActions**：
- 将`querySelectorAll('arithmatex')`改为`querySelectorAll('.arithmatex')`
- 简化renderActions逻辑或考虑移除，让MathJax的`processHtmlClass`配置自动处理

**C. 优化MathJax配置**：
- 确保`processHtmlClass: 'arithmatex'`设置正确
- 添加更详细的错误处理和调试输出

### 3. 优化pymdownx.arithmatex配置
在`mkdocs.yml`中增强配置：
```yaml
- pymdownx.arithmatex:
    generic: true
    preview: false
    tex: true
```

### 4. 添加调试支持
- 增强控制台日志输出
- 添加全局调试函数用于手动检查和重试

## 预期结果
修复后数学公式应能：
1. 正确渲染行内公式（$...$）和块级公式（$$...$$）
2. 在深色/浅色模式下清晰显示
3. 响应式适配不同屏幕尺寸
4. 支持所有测试页面中的数学符号和公式类型

## 验证方法
1. 运行`mkdocs serve`启动本地服务器
2. 访问`/test/test_math/`测试页面
3. 检查浏览器控制台是否有错误
4. 验证所有数学公式正确渲染